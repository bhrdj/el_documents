# Chapter Processing Pipeline

This directory contains chapters at different stages of processing, organized in numbered folders representing the processing pipeline.

## Folder Structure Concept

**Pipeline Stages**: Each numbered folder represents a stage in the document processing pipeline. Outputs from one stage become inputs to the next stage.

**Naming Convention**: `NN_description/` where:
- `NN` = Two-digit sequence number (00, 01, 02, ...)
- `description` = Short name describing this stage's transformation

**Benefits**:
- **Traceability**: Easy to compare outputs at different stages
- **Reproducibility**: Can re-run any stage using previous stage as input
- **Debugging**: Can identify exactly where issues were introduced
- **Rollback**: Can return to any previous stage if needed
- **Documentation**: Folder names document the processing pipeline

## Current Pipeline Stages

### 00_raw/
**Description**: Raw chapter text extracted directly from PDF

**Source**: `EL_CgManual_CURRENT_v016.pdf`

**Processing**: Direct PDF text extraction using pdfplumber

**Characteristics**:
- Unicode bullets (●○■) representing list hierarchy
- Unicode brackets (˹˺) marking key terms
- Page markers ("Page X of XX")
- Footer text with version/date
- PDF line wrapping artifacts

**Files**:
```
chapter_0.md       - Front Matter
chapter_1.md       - [Chapter title]
chapter_2.md       - Child Care
chapter_3.md       - [Chapter title]
chapter_4.md       - [Chapter title]
chapter_5_part1.md - [Chapter title, part 1]
chapter_5_part2.md - [Chapter title, part 2]
chapter_7.md       - [Chapter title]
chapter_8.md       - [Chapter title]
chapter_9.md       - [Chapter title]
```

**Generated by**: `scripts/reformat_manual/extract_pdf.py`

---

### 01_basicreformat/
**Description**: Basic formatting cleanup (SKIPPED - not used in current pipeline)

**Status**: Empty - stage was bypassed in favor of going directly to stage 02

---

### 02_removedbullets/
**Description**: Unicode bullets converted to hierarchical markdown bullets

**Source**: `00_raw/`

**Processing**:
- Convert unicode bullets to markdown with indentation:
  - `●` (filled circle) → `- ` (level 1, no indent)
  - `○` (hollow circle) → `  - ` (level 2, 2-space indent)
  - `■` (filled square) → `    - ` (level 3, 4-space indent)
- Remove PDF artifacts (page markers, footers, duplicate headings)
- Normalize heading format based on numbering depth
- Apply consistent spacing rules
- **Preserve unicode brackets** `˹˺` (content markers)

**Characteristics**:
- Valid vanilla markdown
- Hierarchical bullet lists with proper indentation
- Clean heading structure (#, ##, ###, etc.)
- Unicode brackets preserved
- No page markers or PDF artifacts

**Files**:
```
chapter_00.md       (6.7K, 5 headings, 16 list items)
chapter_01.md       (52K, 282 headings, 408 list items)
chapter_02.md       (28K, 113 headings, 292 list items)
chapter_03.md       (22K, 82 headings, 224 list items)
chapter_04.md       (47K, 114 headings, 467 list items)
chapter_05_part1.md (130K, 566 headings, 1230 list items)
chapter_05_part2.md (121K, 214 headings, 1423 list items)
chapter_07.md       (3.1K, 24 headings, 27 list items)
chapter_08.md       (2.9K, 0 headings, 0 list items)
chapter_09.md       (30K, 47 headings, 91 list items)
```

**Generated by**: `scripts/reformat_manual/reformat_chapter.py`

**Validation**: See `CONVERSION_REPORT.md` in this directory

---

### 03_edited/
**Description**: Editorial review and quality improvements

**Source**: `02_removedbullets/`

**Processing**:
- Grammar corrections (subject-verb agreement, tense, punctuation)
- Clarity improvements (ambiguous pronouns, unclear references)
- Redundancy removal (duplicate content, unnecessary repetition)
- Hierarchy fixes (bullet nesting, section structure, numbering)
- Consistency improvements (terminology, formatting, style)
- **Preserve unicode brackets** `˹˺` (content markers)
- **Preserve content meaning** (no substantive changes)

**Workflow**:
1. Read chapter for understanding
2. Identify issues (grammar, clarity, redundancy, hierarchy)
3. Generate improvement proposals with confidence ratings
4. User approves changes
5. Apply approved edits
6. Generate chapter-specific change log

**Files** (in progress):
```
chapter_00.md       (159 lines, 11 edits, 2 issues flagged)
chapter_07.md       (90 lines, 10 edits)
chapter_08.md       (27 lines, 14 edits)
[Additional chapters in progress...]
```

**Generated by**: Manual editorial review with Claude Code

**Documentation**: See individual `chapter_NN_changes.md` files and `EDITORIAL_REPORT.md` (when complete)

**Flagged Issues**: Some chapters have issues flagged for future reconciliation (e.g., duplicate content sections)

---

### 04_merged/
**Description**: Merge multi-part chapters and apply fixes for PDF generation

**Source**: `02_removedbullets/` (chapter 4) and manual merge of chapter 5 parts

**Processing**:
- Merge chapter_05_part1 + chapter_05_part2 into single chapter_05.md
- Fix emoji and Unicode issues for LaTeX compatibility
- Apply deep nesting fixes for bullet lists

**Files**:
```
chapter_04.md       (47K, from 02_removedbullets with fixes)
chapter_04_fixed.md (fixed version with Unicode replacements)
chapter_05.md       (merged from part1 + part2)
chapter_01_fixed.md (from 02_removedbullets with fixes)
```

**Status**: Partial - some files present but stage not fully formalized

---

### 05_repaired/
**Description**: Document structure repairs applied (Feature 005)

**Source**: `04_merged/` and `02_removedbullets/`

**Processing**:
- **User Story 1**: Chapter 5 content restoration and deduplication
- **User Story 2**: Hierarchical section numbering (1, 1.1, 1.1.1, etc.)
- **User Story 3**: Bullet list hierarchy repair (consistent indentation and markers)
- **Post-fix**: Unicode bullet conversion (●, ○ → markdown)

**Characteristics**:
- Correct hierarchical section numbering throughout
- Standardized bullet list formatting (2 spaces per level, max 4 levels)
- All Unicode bullets converted to markdown
- Ready for PDF generation

**Files**:
```
chapter_01_fixed.md         (53K, 268 headers renumbered, 328 bullets)
chapter_04.md               (from 04_merged)
chapter_04_fixed.md         (78 headers renumbered, 355 bullets)
chapter_05.md               (384K, 174 headers, 3,298 bullets - MAIN)
chapter_05_deduplicated.md  (173 headers, 1,165 bullets)
CHAPTER_5_ANALYSIS.md       (analysis report)
```

**Generated by**:
- `scripts/analyze_chapter5.py` - Content restoration
- `scripts/repair_section_numbering.py` - Section numbering
- `scripts/repair_bullet_hierarchy.py` - Bullet formatting
- `scripts/fix_unicode_bullets.py` - Unicode bullet conversion

**Documentation**: See `specs/005-document-structure-repair/`

---

## PDF Generation

**Script**: `scripts/pdf_generator.py`

**Input Sources**: Configured in script's `main()` function, pulling from various stages:
- chapter_00: `03_edited/`
- chapter_01, 04-05: `05_repaired/`
- chapter_02-03, 09: `02_removedbullets/`
- chapter_07-08: `03_edited/`

**Output**: `output/pdfs/chapter_NN.pdf`

**Preprocessing** (automatic):
- Unicode emoji/symbol stripping (comprehensive)
- Smart quote replacements
- Deep nesting limitation (max 4 levels)
- YAML metadata parsing fixes
- Unicode bracket conversion (˹˺ → [])

**Usage**:
```bash
.venv/bin/python scripts/pdf_generator.py
```

**Documentation**: See `docs/pdf-generation.md`

---

## Future Pipeline Stages (Planned)

### 06_final/ (potential)
**Description**: Final production-ready chapters with all QA complete

---

## Pipeline Workflow

### Adding a New Stage

1. **Create numbered folder**: `mkdir output/markdown/NN_stagename/`
2. **Document in this README**: Add section describing the stage
3. **Create processing script**: `scripts/reformat_manual/process_NN_stagename.py`
4. **Update previous stage's output**: Point to new stage as next step
5. **Generate validation report**: Document what changed in this stage

### Re-running a Stage

To re-run any stage:

```bash
# Example: Re-run bullet conversion (stage 02)
.venv/bin/python scripts/reformat_manual/reformat_chapter.py <chapter_num>
```

The script reads from `00_raw/` and outputs to the configured output directory.

### Comparing Stages

To see what changed between stages:

```bash
# Compare raw vs. converted
diff output/markdown/00_raw/chapter_2.md output/markdown/02_removedbullets/chapter_02.md

# Count unicode bullets in each stage
grep -r "●\|○\|■" output/markdown/00_raw/ | wc -l
grep -r "●\|○\|■" output/markdown/02_removedbullets/ | wc -l
```

---

## Design Principles

### 1. Immutability
**Never modify files in earlier stages**. Each stage creates new output files. This ensures:
- Previous stages remain available for comparison
- Pipeline can be re-run without data loss
- Easy to identify when/where issues were introduced

### 2. Traceability
**Every transformation is documented**:
- Folder name describes the transformation
- Processing script is version controlled
- Validation reports capture before/after statistics

### 3. Incremental Processing
**Each stage does one thing well**:
- Single, well-defined transformation per stage
- Clear input/output contracts
- Easier to test and validate
- Simpler to debug issues

### 4. Version Control
**All stages are committed to git**:
- Raw extraction results
- Intermediate processing outputs
- Final results
- This allows tracking how outputs change over time

---

## File Naming Conventions

### Within Each Stage Folder

**Chapter files**: `chapter_NN.md` or `chapter_NN_partN.md`
- Zero-padded chapter numbers (00, 01, 02, ...)
- Lowercase filename
- Part designation when chapter is split (part1, part2, ...)

**Metadata files**:
- `CONVERSION_REPORT.md` - Summary of transformations applied
- `README.md` - Stage-specific documentation
- `validation_results.json` - Automated validation output (if applicable)

---

## References

### Processing Pipeline
- [Formatting Guide](../../specs/001-reformat-manual/formatting-guide.md)
- [Implementation Plan](../../specs/001-reformat-manual/plan.md)
- [Unicode Bullet Conversion Plan](../../specs/001-reformat-manual/unicode-bullet-conversion-plan.md)
- [Conversion Report](./02_removedbullets/CONVERSION_REPORT.md)

### Document Structure Repairs
- [Feature 005 Specification](../../specs/005-document-structure-repair/spec.md)
- [Implementation Summary](../../specs/005-document-structure-repair/IMPLEMENTATION_SUMMARY.md)
- [Chapter 5 Analysis](./05_repaired/CHAPTER_5_ANALYSIS.md)

### PDF Generation
- [PDF Generation Documentation](../../docs/pdf-generation.md)

---

**Last Updated**: 2025-11-06
**Pipeline Version**: 1.1
